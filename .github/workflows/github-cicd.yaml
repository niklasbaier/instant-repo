name: CI/CD Pipeline

on:
  push:
    branches:
      - main

# TODO: separate into qa, build, review, bump, release, deploy?
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read Python version from .python-version file
        id: python_version
        run: echo "::set-output name=PYTHON_VERSION::$(cat .python-version)"

      - name: Set up Python ${{ steps.python_version.outputs.PYTHON_VERSION }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ steps.python_version.outputs.PYTHON_VERSION }}

      - name: Read Poetry version from .poetry-version file
        id: poetry_version
        run: echo "::set-output name=POETRY_VERSION::$(cat .poetry-version)"

      - name: Install pipx
        run: python3 -m pip install --user pipx

      - name: Install Poetry ${{ steps.poetry_version.outputs.POETRY_VERSION }}
        run: |
          python3 -m pipx ensurepath
          pipx install poetry==${{ steps.poetry_version.outputs.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: QA - Ensure correct specifications of dependencies
        run: poetry check

      - name: QA - Static tests - Linting with Ruff
        run: poetry run ruff check .

      - name: QA - unit tests
        run: poetry run pytest tests/unit

      - name: QA - integration tests
        run: poetry run pytest tests/integration

      - name: QA - acceptance tests
        run: poetry run pytest tests/acceptance

      # - name: QA - report test results (codecov)
      #   run: ...

      # only applicable, if using an API service that uses OpenAPI
      # - name: QA - OpenAPI spec linting
      #   run: poetry run openapi-spec-validator services/api/openapi.yml

  # bump:
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Read Poetry version from .poetry-version file
        id: poetry_version
        run: echo "::set-output name=POETRY_VERSION::$(cat .poetry-version)"

      - name: Install pipx
        run: python3 -m pip install --user pipx

      - name: Install Poetry ${{ steps.poetry_version.outputs.POETRY_VERSION }}
        run: |
          python3 -m pipx ensurepath
          pipx install poetry==${{ steps.poetry_version.outputs.POETRY_VERSION }}

      - name: Deploy docs
        run: poetry run mkdocs gh-deploy --force
